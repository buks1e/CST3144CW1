<!DOCTYPE html>
<html lang="en">
    <head>
        <title>After School Club</title>
        <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div id="app">
            <header>
                <h1 v-text="sitename" style="text-align: center;"></h1>
                <button v-if="cartItemCount != '' || showProduct == false" v-on:click="showCheckout">
                    {{ cartItemCount }}
                    <span class="fas fa-cart-plus"></span> 
                    Checkout
                </button>
                <button v-else disabled>
                    <span class="fas fa-cart-plus"></span> 
                    Checkout
                </button>
                <input type="search" v-if="showProduct" v-model.trim="Query" v-on:input="findQuery" placeholder="Search">
                <input type="search" v-else disabled placeholder="Search">
            </header>

            <div v-if="showProduct">
                <div class="prodPage" style="width: 10%;position: sticky;left: 0%;">
                    <h2>Sort By</h3>
                    <p><input type="radio" value="0" v-model="sortSetting">Name</p>
                    <p><input type="radio" value="1" v-model="sortSetting">Location</p>
                    <p><input type="radio" value="2" v-model="sortSetting">Price</p>
                    <p><input type="radio" value="3" v-model="sortSetting">Availability</p>
                    <h2>Sort Order</h3>
                    <p><input type="radio" value="1" v-model="sortOrder">Ascending</p> 
                    <p><input type="radio" value="-1" v-model="sortOrder">Descending</p>
                </div>

                <div class="prodPage" v-if="emptySearch">
                    <h2 style="text-align: center;">There are no results matching your query</h2>
                </div>

                <div class="prodPage">
                    <div style="display: inline-flex;flex-flow:wrap;">
                        <div class="items" v-for="club in sortedClubs">
                            <img v-bind:src="`http://localhost:3000/image/${club.image}`" v-bind:alt="club.alt" style="height: 125px; width: 125px; display: inline-block;">
                            <div class="info" style="display: inline-block;">
                                <h2 v-text="club.subject"></h2>
                                <p>Location: {{club.location}}</p>
                                <p>Price: {{club.price}}</p>
                                <p>Spaces: {{club.availableSlots}}</p>
                                <p>
                                    <span v-for="n in club.rating">★</span>
                                    <span v-for="n in 5 - club.rating">☆</span>
                                </p>
                            </div>
                            <button v-on:click="addCart(club)" v-if="canAddToCart(club)">Add to Cart</button>
                            <button disabled="disabled" v-else>Add to Cart</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else>
                <h2>Cart Items</h2>
                <div style="display: inline-flex;align-items: flex-end;margin: 1%;" v-for="club in cartDisplay">
                    <img v-bind:src="`http://localhost:3000/image/${club.image}`" v-bind:alt="club.alt" style="height: 125px; width: 125px; display: inline-block;">
                    <div style="display: inline-block;">
                        <h2 v-text="club.subject"></h2>
                        <p>Location: {{club.location}}</p>
                        <p>Price: {{club.price}}</p>
                        <p>Spaces reserved: {{club.count}}</p >
                    </div>
                    <div style="display: flex;flex-direction: column;align-items: center;">
                        <input type="number" min="1" max="9" value="1" v-on:input="setMax($event, club)">
                        <button v-on:click="removeFromCart($event,club)">Remove from Cart</button>
                        <p></p>
                    </div>
                </div>
                <div v-if="cartItemCount == ''"><p>Cart is Empty</p></div>
                <h2>Checkout</h2>
                <p>
                    <strong>First Name:</strong>
                    <input v-model.trim="order.firstName">
                </p>
                <p>
                    <strong>Last Name:</strong>
                    <input v-model.trim="order.lastName">
                </p>
                <p><strong>Phone Number:</strong> <input v-model.number="order.phone"></p>
                    <strong>Emirate:</strong>
                    <select v-model="order.emirate">
                        <option disabled>--Emirate--</option>
                        <option v-for="(emirate, key) in emirates" v-bind:value="emirate">{{emirate}}</option>
                    </select>
                </p>

                <h2>Order Information</h2>
                <p>First Name: {{order.firstName}}</p>
                <p>Last Name: {{order.lastName}}</p>
                <p>Phone Number: {{order.phone}}</p>
                <p>Emirate: {{order.emirate}}</p>

                <button v-if="cartItemCount != '' && valueCheck" v-on:click="submitForm">Place Order</button>
                <button v-else disabled v-on:click="submitForm">Place Order</button>
            </div>
        </div>
        <script>
            let app = new Vue ({
                el: '#app',
                data: {
                    sortSetting: 0,
                    sortOrder: 1,
                    showProduct: true,
                    sitename: "After School Club",
                    cart: [],
                    Query: "",
                    SearchedClubs: [],
                    emptySearch: false,
                    clubs: [],
                    order: {
                        firstName: '',
                        lastName: '',
                        phone: '',
                        emirate: '',
                        LessonIDs: []
                    },
                    emirates: {
                        Du: 'Dubai',
                        Ad: 'Abu Dhabi',
                        Sh: 'Sharjah',
                        Aj: 'Ajman'
                    }
                },

                created(){
                    this.clubs = fetch('http://localhost:3000/collection/Lessons', {method: 'GET'})
                    .then(response => response.json())
                    .then(responseJSON => {return responseJSON})
                    .catch((error) => {console.log(error); return []});
                },

                methods: {
                    addCart: function(club) {
                        this.cart.push(club._id);
                        club.availableSlots --;
                    },
                    showCheckout: function(){
                        this.showProduct = this.showProduct ? false:true;
                    },
                    submitForm: function() {
                        let Cart = this.cart.slice(0);
                        let uniqueCart = [];
                        let LessonCount = [];
                        Cart.forEach(i =>{
                            if(uniqueCart.indexOf(i) == -1 ){
                                uniqueCart.push(i);
                                let currentClub = this.clubs.find(x => {return x._id == i});
                                let dummy= {
                                    "_id": i,
                                    "subject": currentClub.subject,
                                    "count": 1
                                }
                                LessonCount.push(dummy);
                            }
                            else{
                                LessonCount.forEach(j =>{
                                    if(j._id === i){
                                        j.count++
                                    }
                                })
                            }
                        });
                        this.order.LessonIDs = LessonCount;
                        
                        fetch('http://localhost:3000/collection/Orders', {
                            method: 'POST', // set the HTTP method as 'POST'
                            headers: {
                                'Content-Type': 'application/json', // set the data type as JSON
                            },
                            body: JSON.stringify(this.order), // need to stringify the JSON object
                        });
                        
                        this.order.LessonIDs.forEach(i =>{
                            let current = fetch(`http://localhost:3000/collection/Lessons/${i._id}`, {method: 'GET'})
                            .then(response => response.json())
                            .then(responseJSON => {return responseJSON})
                            .catch((error) => {console.log(error);});

                            let dummy = {availableSlots: current.availableSlots - i.count}
                            
                            fetch(`http://localhost:3000/collection/Lessons/${i._id}`, {
                                method: 'PUT', // set the HTTP method as 'POST'
                                headers: {
                                    'Content-Type': 'application/json', // set the data type as JSON
                                },
                                body: JSON.stringify(dummy), // need to stringify the JSON object
                            });
                        });
                        
                        alert('Order Placed');
                    },

                    canAddToCart: function(club){
                        return club.availableSlots > 0;
                    },

                    removeFromCart: function(event,club){
                        const item = event.target;
                        let removeBy = parseInt(item.parentNode.firstChild.value);
                        if(!isNaN(removeBy)){
                            for(let i = 0;i<removeBy;i++){
                                let toRemove = this.cart.indexOf(club._id);
                                let pap = this.cart.splice(toRemove, 1);
                                console.log(typeof(pap[0]));
                            }
                            club.availableSlots = club.availableSlots + removeBy;
                            item.parentNode.firstChild.value = "";
                        }
                    },
                    findQuery: function(){
                        let empt = /\S/;
                        if(empt.test(this.Query)){
                            let foundArray = fetch(`http://localhost:3000/search/Lessons/${this.Query}`, {method: 'GET'})
                            .then(response => response.json())
                            .then(responseJSON => {return responseJSON})
                            .catch((error) => {console.log(error);});
                            this.SearchedClubs = foundArray;
                        }
                        else {this.SearchedClubs = [];}
                    },
                    setMax: function(event, club) {
                        const item = event.target;
                        item.setAttribute("max",club.count);
                        if(item.value>club.count){
                            item.parentNode.children[1].setAttribute("disabled","disabled");
                            item.parentNode.children[2].innerText = "You are trying to remove too much";
                        }
                        else{
                            item.parentNode.children[1].removeAttribute("disabled");
                            item.parentNode.children[2].innerText = "";
                        }
                    }

                },

                computed:{
                    cartItemCount: function(){
                        return this.cart.length || "";
                    },
                    sortedClubs: function() {
                        let clubsArray = [];
                        let empt = /\S/
                        if(empt.test(this.Query)){
                            clubsArray = this.SearchedClubs.slice(0);
                            if(clubsArray.length == 0){this.emptySearch = true}
                            else this.emptySearch = false;
                        }
                        else {
                            clubsArray = this.clubs.slice(0);
                            this.emptySearch = false;
                        }
                        let sort = this.sortOrder
                        if(this.sortSetting == 1) {
                            function compare(a,b) { 
                                if (a.location > b.location)
                                    return sort;
                                if (a.location < b.location)
                                    return -sort;
                                return 0;
                            }
                        }
                        else if(this.sortSetting == 2) {
                            function compare(a,b) { 
                                if (a.price > b.price)
                                    return sort;
                                if (a.price < b.price)
                                    return -sort;
                                return 0;
                            }
                        }
                        else if(this.sortSetting == 3) {
                            function compare(a,b) { 
                                if (a.availableSlots > b.availableSlots)
                                    return sort;
                                if (a.availableSlots < b.availableSlots)
                                    return -sort;
                                return 0;
                            }
                        }
                        else{
                            function compare(a,b) { 
                                if (a.subject > b.subject)
                                    return sort;
                                if (a.subject < b.subject)
                                    return -sort;
                                return 0;
                            }
                        }
                        return clubsArray.sort(compare); 
                    },
                    cartDisplay: function(){
                        //create seperate list of lessons
                        let clubsArray = this.clubs.slice(0);

                        //adding a count property to each lesson object to count each time it appears in the cart
                        clubsArray.forEach(item => {item.count = 0;});
                        
                        // Count occurrences in the cart
                        for (let i of this.cart) {
                            let j = clubsArray.find(item => item._id == i);
                            if (j != undefined) {j.count++;}
                        }

                        // Filter clubs that are in the cart
                        return clubsArray.filter(j => j.count > 0);
                    },
                    valueCheck: function(){
                        let names = /^[a-z]+$/i
                        let numbers = /^[0-9]+$/
                        let empt = /\S/
                        testValue = names.test(this.order.firstName) && names.test(this.order.lastName) && numbers.test(this.order.phone)
                        emptyTest = empt.test(this.order.firstName) && empt.test(this.order.lastName) && empt.test(this.order.phone) && empt.test(this.order.emirate)
                        return testValue && emptyTest
                    }                     

                }

            });
        </script>
    </body>
</html>